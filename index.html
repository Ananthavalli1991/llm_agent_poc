<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Agent POC</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- Bootstrap LLM Provider and Alert CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .chat-container {
            height: 75vh;
            overflow-y: auto;
            border-radius: 12px;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
        }

        .user-message {
            background-color: #3b82f6;
            color: #ffffff;
            align-self: flex-end;
        }

        .agent-message {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
        }

        .tool-message {
            background-color: #d1fae5;
            color: #065f46;
            font-style: italic;
            border-left: 4px solid #10b981;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-container {
            border-radius: 12px;
            background-color: #ffffff;
            padding: 1rem;
        }
    </style>
</head>

<body class="p-6 flex flex-col items-center justify-center min-h-screen">

    <div class="card w-full max-w-2xl bg-white p-6 shadow-xl border border-gray-200 rounded-lg">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">LLM Agent POC</h1>

        <!-- Alert Area -->
        <div id="alert-container" class="mb-4"></div>

        <!-- Conversation History -->
        <div id="chat-history" class="chat-container flex flex-col space-y-4 p-4 mb-4 shadow-inner">
            <div class="agent-message message self-start">Hi there! What can I help you with today?</div>
        </div>

        <!-- Input and Controls -->
        <div class="flex flex-col form-container">
            <div class="flex items-center space-x-2 mb-4">
                <label for="model-selector" class="text-gray-600 font-medium">Model:</label>
                <select id="model-selector" class="form-select flex-grow">
                    <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <input type="text" id="user-input" placeholder="Type a message..." class="form-control flex-grow border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                <button id="send-btn" class="btn btn-primary bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors shadow-md">Send</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // Global variables for Firebase configuration.
        // These are populated by the hosting environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization (Required for Canvas) ---
        // Although this app doesn't use Firestore, Firebase auth is required to be initialized.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Initialize Firebase
        let app;
        let auth;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            console.log("Firebase initialized.");
            
            // Sign in with the custom token or anonymously
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken)
                    .then(() => console.log("Signed in with custom token."))
                    .catch(e => {
                        console.error("Failed to sign in with custom token:", e);
                        signInAnonymously(auth).then(() => console.log("Signed in anonymously."));
                    });
            } else {
                signInAnonymously(auth).then(() => console.log("Signed in anonymously."));
            }
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // --- UI Elements ---
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const chatHistory = document.getElementById('chat-history');
        const alertContainer = document.getElementById('alert-container');
        const modelSelector = document.getElementById('model-selector');

        // --- Core Agent State ---
        let conversationHistory = [];
        let isProcessing = false;

        // --- API and Tool Definitions ---
        const apiKey = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Tool declarations for the LLM to call.
        const tools = [{
            function_declarations: [{
                name: "google_search",
                description: "Search Google for information.",
                parameters: {
                    type: "OBJECT",
                    properties: {
                        query: {
                            type: "STRING",
                            description: "The search query string."
                        }
                    },
                    required: ["query"]
                }
            }, {
                name: "aipipe",
                description: "Run a task through an AI pipeline.",
                parameters: {
                    type: "OBJECT",
                    properties: {
                        pipeline_id: {
                            type: "STRING",
                            description: "The ID of the AI pipeline to run."
                        },
                        data: {
                            type: "OBJECT",
                            description: "The data to pass to the pipeline.",
                            additionalProperties: true
                        }
                    },
                    required: ["pipeline_id", "data"]
                }
            }, {
                name: "js_code_execution",
                description: "Execute JavaScript code securely in a sandboxed environment.",
                parameters: {
                    type: "OBJECT",
                    properties: {
                        code: {
                            type: "STRING",
                            description: "The JavaScript code to execute."
                        }
                    },
                    required: ["code"]
                }
            }]
        }];

        // --- UI Functions ---
        /** Adds a message to the chat history UI. */
        function addMessage(text, type) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', 'transition-all', 'duration-300', 'ease-in-out', 'transform', 'translate-y-4', 'opacity-0');
            msgDiv.textContent = text;
            if (type === 'user') {
                msgDiv.classList.add('user-message', 'self-end');
            } else if (type === 'agent') {
                msgDiv.classList.add('agent-message', 'self-start');
            } else if (type === 'tool') {
                msgDiv.classList.add('tool-message', 'self-start');
            }
            chatHistory.appendChild(msgDiv);
            setTimeout(() => {
                msgDiv.classList.remove('translate-y-4', 'opacity-0');
            }, 10);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        /** Shows a Bootstrap alert message. */
        function showAlert(message, type = 'danger') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show rounded-md shadow-sm`;
            alertDiv.innerHTML = `
                <div>${message}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
        }

        /** Enables/disables the input and button. */
        function setUIState(enabled) {
            isProcessing = !enabled;
            userInput.disabled = !enabled;
            sendBtn.disabled = !enabled;
            sendBtn.textContent = enabled ? 'Send' : 'Thinking...';
        }

        // --- Tool Handling Functions ---

        /** Calls Google Search and returns a formatted result string. */
        async function handleGoogleSearch(query) {
            addMessage(`Calling Google Search with query: "${query}"`, 'tool');
            try {
                // The tool call will use the built-in Google Search grounding.
                const searchResult = await makeLLMCall(query, true); // Use grounding
                if (searchResult.text) {
                    addMessage("Search results received.", 'tool');
                    return {
                        tool_response: {
                            name: "google_search",
                            content: {
                                results: [{ text: searchResult.text }]
                            }
                        }
                    };
                } else {
                    return {
                        tool_response: {
                            name: "google_search",
                            content: {
                                error: "No search results found."
                            }
                        }
                    };
                }
            } catch (error) {
                console.error("Google Search error:", error);
                showAlert("Failed to perform search. Please try again.", 'warning');
                return {
                    tool_response: {
                        name: "google_search",
                        content: {
                            error: `Search failed with error: ${error.message}`
                        }
                    }
                };
            }
        }

        /** Simulates an AI Pipe API call. */
        async function handleAIPipe(pipelineId, data) {
            addMessage(`Calling AI Pipe '${pipelineId}' with data: ${JSON.stringify(data)}`, 'tool');
            try {
                // This is a placeholder call. A real implementation would require a valid API.
                const response = await fetch('https://api.aipipe.io/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pipeline_id: pipelineId, data: data })
                });
                const result = await response.json();
                addMessage("AI Pipe execution successful.", 'tool');
                return {
                    tool_response: {
                        name: "aipipe",
                        content: {
                            result: result
                        }
                    }
                };
            } catch (error) {
                console.error("AI Pipe error:", error);
                showAlert("Failed to call AI Pipe. The API is simulated and may not work.", 'warning');
                return {
                    tool_response: {
                        name: "aipipe",
                        content: {
                            error: `AI Pipe call failed with error: ${error.message}`
                        }
                    }
                };
            }
        }

        /** Executes JavaScript code in a sandboxed iframe. */
        async function handleCodeExecution(code) {
            addMessage("Executing JavaScript code...", 'tool');
            return new Promise((resolve, reject) => {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.sandbox = "allow-scripts"; // Only allow scripts
                document.body.appendChild(iframe);

                const scriptContent = `
                    <script>
                        window.onerror = function(message, source, lineno, colno, error) {
                            parent.postMessage({ type: 'result', error: message }, '*');
                            return true;
                        };
                        try {
                            const result = eval(\`${code.replace(/`/g, '\\`')}\`);
                            parent.postMessage({ type: 'result', result: result }, '*');
                        } catch (e) {
                            parent.postMessage({ type: 'result', error: e.message }, '*');
                        }
                    </script>
                `;

                iframe.contentWindow.document.open();
                iframe.contentWindow.document.write(scriptContent);
                iframe.contentWindow.document.close();

                const listener = (event) => {
                    if (event.source === iframe.contentWindow) {
                        window.removeEventListener('message', listener);
                        document.body.removeChild(iframe);
                        if (event.data.error) {
                            console.error("Code execution error:", event.data.error);
                            showAlert("Code execution failed.", 'warning');
                            resolve({
                                tool_response: {
                                    name: "js_code_execution",
                                    content: { error: event.data.error }
                                }
                            });
                        } else {
                            addMessage("Code execution successful.", 'tool');
                            resolve({
                                tool_response: {
                                    name: "js_code_execution",
                                    content: { result: String(event.data.result) }
                                }
                            });
                        }
                    }
                };
                window.addEventListener('message', listener);
            });
        }

        // --- Main Agent Logic ---

        /** Makes the LLM API call with the current conversation history and tools. */
        async function makeLLMCall(query, useGrounding = false) {
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: query }]
                }],
                tools: tools,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            text: { "type": "STRING" },
                            tool_calls: {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "name": { "type": "STRING" },
                                        "args": { "type": "OBJECT", "additionalProperties": true }
                                    },
                                    "required": ["name", "args"]
                                }
                            }
                        }
                    }
                }
            };
            
            // Add conversation history to the payload
            payload.contents = [{
                role: "user",
                parts: [{ text: query }]
            }];

            if (conversationHistory.length > 0) {
                payload.contents = [...conversationHistory, ...payload.contents];
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                    return parsedJson;
                } else {
                    return {};
                }
            } catch (error) {
                console.error("LLM API call failed:", error);
                showAlert("LLM API call failed. Please check your network or try again later.", 'danger');
                throw error;
            }
        }

        /** The main agent loop that handles user input and tool calls. */
        async function runAgent(userQuery) {
            setUIState(false);
            addMessage(userQuery, 'user');
            conversationHistory.push({ role: "user", parts: [{ text: userQuery }] });

            while (true) {
                try {
                    const llmResponse = await makeLLMCall(userQuery);
                    
                    const textOutput = llmResponse.text || '';
                    const toolCalls = llmResponse.tool_calls || [];

                    // Always display LLM output
                    if (textOutput) {
                        addMessage(textOutput, 'agent');
                        conversationHistory.push({ role: "model", parts: [{ text: textOutput }] });
                    }

                    // If there are no tool calls, the task is complete for now.
                    if (toolCalls.length === 0) {
                        break;
                    }

                    // Execute tool calls
                    const toolResponses = [];
                    for (const toolCall of toolCalls) {
                        const { name, args } = toolCall;
                        let toolResult;
                        if (name === 'google_search') {
                            toolResult = await handleGoogleSearch(args.query);
                        } else if (name === 'aipipe') {
                            toolResult = await handleAIPipe(args.pipeline_id, args.data);
                        } else if (name === 'js_code_execution') {
                            toolResult = await handleCodeExecution(args.code);
                        } else {
                            showAlert(`Unknown tool called: ${name}`, 'warning');
                            toolResult = { tool_response: { name: name, content: { error: "Unknown tool" } } };
                        }
                        toolResponses.push(toolResult);
                    }
                    
                    // Append tool responses to the history for the next turn
                    for (const res of toolResponses) {
                        conversationHistory.push({
                            role: "tool",
                            parts: [{ function_response: res.tool_response }]
                        });
                    }
                    
                    // Continue the loop with the tool responses.
                    userQuery = "Based on the tool results, continue the conversation or call another tool.";

                } catch (error) {
                    console.error("Agent loop error:", error);
                    showAlert("An error occurred during agent processing. Please check the console.", 'danger');
                    break;
                }
            }

            setUIState(true);
        }

        // --- Event Listeners ---
        sendBtn.addEventListener('click', () => {
            if (isProcessing) return;
            const query = userInput.value.trim();
            if (query) {
                userInput.value = '';
                runAgent(query);
            }
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !isProcessing) {
                e.preventDefault();
                sendBtn.click();
            }
        });
    </script>
</body>

</html>
